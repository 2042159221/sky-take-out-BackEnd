# 需求分析与设计 - 分类管理功能

## 一、需求概述

后台系统中需要管理分类信息，分类包括两种类型，分别是**菜品分类**和**套餐分类**。

## 二、菜品分类功能分析

### 1. 功能点

1. **新增菜品分类**：当在后台系统中添加菜品时需要选择一个菜品分类，在移动端也会按照菜品分类来展示对应的菜品。
2. **菜品分类分页查询**：系统中的分类很多时，以分页方式展示列表数据，便于查看。
3. **根据id删除菜品分类**：在分类管理列表页面，可以对某个分类进行删除操作。当分类关联了菜品或者套餐时，此分类不允许删除。
4. **修改菜品分类**：在分类管理列表页面点击修改按钮，弹出修改窗口，回显分类信息并进行修改，最后点击确定按钮完成修改操作。
5. **启用禁用菜品分类**：在分类管理列表页面，可以对某个分类进行启用或者禁用操作。
6. **分类类型查询**：当点击分类类型下拉框时，从数据库中查询所有的菜品分类数据进行展示。

### 2. 业务规则

- 分类名称必须是唯一的
- 分类按照类型可以分为菜品分类和套餐分类
- 新添加的分类状态默认为"禁用"

## 三、数据库设计

### category表结构

| **字段名**  | **数据类型** | **说明**     | **备注**            |
| ----------- | ------------ | ------------ | ------------------- |
| id          | bigint       | 主键         | 自增                |
| name        | varchar(32)  | 分类名称     | 唯一                |
| type        | int          | 分类类型     | 1菜品分类 2套餐分类 |
| sort        | int          | 排序字段     | 用于分类数据的排序  |
| status      | int          | 状态         | 1启用 0禁用         |
| create_time | datetime     | 创建时间     |                     |
| update_time | datetime     | 最后修改时间 |                     |
| create_user | bigint       | 创建人id     |                     |
| update_user | bigint       | 最后修改人id |                     |

## 四、接口设计

菜品分类模块共涉及6个接口：

### 1. 新增分类

- 请求方式：POST
- 请求路径：/admin/category
- 请求头：
  - Content-Type: application/json
- 请求参数：
  | 名称   | 类型      | 是否必须 | 默认值 | 备注                 | 其他信息          |
  | ---- | ------- | ---- | --- | ------------------ | ------------- |
  | id   | integer | 非必须  |     |                    | format: int64 |
  | name | string  | 必须   |     | 分类名称               |               |
  | sort | integer | 必须   |     | 排序，按照升序排序          | format: int32 |
  | type | integer | 必须   |     | 分类类型：1为菜品分类，2为套餐分类 | format: int32 |
- 响应数据：
  | 名称   | 类型      | 是否必须 | 默认值 | 备注 | 其他信息          |
  | ---- | ------- | ---- | --- | -- | ------------- |
  | code | integer | 必须   |     |    | format: int32 |
  | data | string  | 非必须  |     |    |               |
  | msg  | string  | 非必须  |     |    |               |

### 2. 分类分页查询

- 请求方式：GET
- 请求路径：/admin/category/page
- 请求参数：
  | 参数名称   | 数据类型 | 是否必须 | 默认值 | 备注                   |
  | -------- | ------ | -------- | ------ | ---------------------- |
  | name     | 字符串  | 否      | 传统主食       | 分类名称               |
  | page     | 整数    | 是      | 1      | 页码                   |
  | pageSize | 整数    | 是      | 10     | 每页记录数             |
  | type     | 整数    | 否      | 1      | 分类类型：1为菜品分类，2为套餐分类 |
- 响应数据：
  | 名称         | 数据类型     | 是否必须 | 默认值 | 备注          |
  | ------------ | ------------ | -------- | ------ | ------------- |
  | code         | number       | 必须     |        |               |
  | msg          | null         | 非必须   |        |               |
  | data         | object       | 必须     |        |               |
  | ├─ total     | number       | 必须     |        | 总记录数      |
  | ├─ records   | object     | 必须     |        | 当前页数据列表 |
  | │  ├─ id     | number       | 必须     |        |               |
  | │  ├─ type   | number       | 必须     |        |               |
  | │  ├─ name   | string       | 必须     |        |               |
  | │  ├─ sort   | number       | 必须     |        |               |
  | │  ├─ status | number       | 必须     |        |               |
  | │  ├─ createTime | string   | 必须     |        |               |
  | │  ├─ updateTime | string   | 必须     |        |               |
  | │  ├─ createUser | number   | 必须     |        |               |
  | │  └─ updateUser | number   | 必须     |        |               |

### 3. 根据id删除分类

- 请求方式：DELETE
- 请求路径：/admin/category/{id}
- 请求参数：
  | 参数名称 | 数据类型 | 是否必须 | 示例 | 备注   |
  | -------- | -------- | -------- | ------ | ------ |
  | id       | 整数     | 是       |    100    | 分类id |
- 响应数据：
  | 名称         | 数据类型     | 是否必须 | 默认值 | 备注          |
  | ------------ | ------------ | -------- | ------ | ------------- |
  | code         | integer       | 必须     |        |format int32               |
  | data         | string       | 非必须   |        |               |
  | msg          | string       | 非必须   |        |               |

### 4. 修改分类

- 请求方式：PUT
- 请求路径：/admin/category
- 请求头：
  - Content-Type: application/json
- 请求参数：
  | 参数名称 | 数据类型 | 是否必须 | 默认值 | 备注         |
  | -------- | -------- | -------- | ------ | ------------ |
  | id       | 整数     | 是       |        | 分类id    ，format:int64 |
  | name     | 字符串   | 是       |        | 分类名称     |
  | sort     | 整数     | 是       |        | 排序，按照升序排序,format:int32 |
  | type     |integer   |是        |        |分类类型 ,format:int32
- 响应数据：
  | 名称         | 数据类型     | 是否必须 | 默认值 | 备注          |
  | ------------ | ------------ | -------- | ------ | ------------- |
  | code         | integer       | 必须     |        |  format:int32             |
  | data         | string       | 非必须   |        |               |
  | msg          | string       | 非必须   |        |               |

### 5. 启用禁用分类

- 请求方式：POST
- 请求路径：/admin/category/status/{status}
- 请求头：
  - Content-Type: application/json
- 请求参数：
  | 参数名称 | 数据类型 | 是否必须 | 示例 | 备注             |
  | -------- | -------- | -------- | ------ | ---------------- |
  | id       | 整数     | 是       |   100     | 分类id           |
  | status   | 整数     | 是       |    1    | 状态：1启用，0禁用 |
- 响应数据：
  | 名称         | 数据类型     | 是否必须 | 默认值 | 备注          |
  | ------------ | ------------ | -------- | ------ | ------------- |
  | code         |integer       | 必须     |        |  format：int32             |
  | data         | string       | 非必须   |        |               |
  | msg          | string       | 非必须   |        |               |

### 6. 根据类型查询分类

- 基本信息  
  - Path：/admin/category/list  
  - Method：GET  

- 请求参数（Query）：

  | 参数名称 | 是否必须 | 示例 | 备注 |
  | -------- | -------- | ---- | ---- |
  | type     | 否       | 2    | 分类类型：1为菜品分类，2为套餐分类 |

- 返回数据：

  | 名称           | 类型     | 是否必须 | 默认值 | 备注                | 其他信息                |
  | -------------- | -------- | -------- | ------ | ------------------- | ----------------------- |
  | code           | integer  | 必须     |        | 状态码              | format:int32            |
  | data           | array    | 非必须   |        | 分类列表数据        | item类型:object         |
  | └─ createTime  | string   | 非必须   |        | 创建时间            | format:date-time        |
  | └─ createUser  | integer  | 非必须   |        | 创建人              | format:int64            |
  | └─ id          | integer  | 非必须   |        | 分类id              | format:int64            |
  | └─ name        | string   | 非必须   |        | 分类名称            |                         |
  | └─ sort        | integer  | 非必须   |        | 排序                | format:int32            |
  | └─ status      | integer  | 非必须   |        | 状态（0禁用1启用）  | format:int32            |
  | └─ type        | integer  | 非必须   |        | 分类类型            | format:int32            |
  | └─ updateTime  | string   | 非必须   |        | 修改时间            | format:date-time        |
  | └─ updateUser  | integer  | 非必须   |        | 修改人              | format:int64            |
  | msg            | string   | 非必须   |        | 提示信息            |                         |

## 五、组件设计

### 1. 实体类

- Category：对应数据库中的category表

### 2. 控制器

- CategoryController：处理前端请求，调用service层方法

### 3. 服务接口

- CategoryService：定义业务逻辑方法

### 4. 服务实现

- CategoryServiceImpl：实现CategoryService接口中的方法

### 5. 数据访问

- CategoryMapper：操作数据库
### 6. 菜品和套餐实体

- Dish：对应数据库中的dish表
- Setmeal：对应数据库中的setmeal表

### 7. 菜品和套餐数据访问

- DishMapper：操作菜品相关数据
  - 根据分类id查询菜品数量
  - 根据状态和分类id查询菜品列表
  - 新增菜品
  - 根据id查询菜品
  - 修改菜品信息
  - 根据id删除菜品

- SetmealMapper：操作套餐相关数据
  - 根据分类id查询套餐数量
  - 根据状态和分类id查询套餐列表
  - 新增套餐
  - 根据id查询套餐
  - 修改套餐信息
  - 根据id删除套餐



## 六、业务逻辑

### 1. 新增分类

- 校验分类名称是否已存在，确保名称唯一性
- 设置分类名称
- 设置默认状态为禁用(0)
- 设置分类类型(type)：1为菜品分类，2为套餐分类
- 设置排序字段(sort)值
- 设置创建时间、修改时间、创建人ID、修改人ID
- 保存分类信息到数据库
- 返回操作结果，成功时返回成功消息

### 2. 分类分页查询

- 构建查询条件
- 执行分页查询
- 封装结果返回

### 3. 根据id删除分类

- 检查该分类是否关联了菜品或套餐，如果有关联则不允许删除
- 执行删除操作

### 4. 修改分类

- 根据id查询原有分类信息
- 更新分类信息
- 设置修改时间和修改人
- 保存修改

### 5. 启用禁用分类

- 根据id查询分类
- 修改状态
- 设置修改时间和修改人
- 保存修改

### 6. 根据类型查询分类

- 构建查询条件（按类型和状态）
- 执行查询
- 返回分类列表

## 七、异常处理

### 1. 分类名称重复

- 在新增和修改操作时，需要检查分类名称是否已存在
- 如果存在，应返回业务异常，提示"分类名称已存在"

### 2. 分类关联了菜品或套餐时的删除操作

- 在删除前，需要查询该分类是否被菜品或套餐引用
- 如果有引用关系，应返回业务异常，提示"当前分类关联了菜品或套餐，不能删除"

### 3. 参数校验

- 对必填参数进行非空校验
- 对数据类型和取值范围进行校验

### 4. 记录不存在

- 在修改、删除、启用禁用操作时，需要先检查记录是否存在
- 如果不存在，应返回业务异常，提示"分类不存在"

### 5. 并发操作

- 考虑乐观锁或悲观锁来处理并发修改的情况

### 6. 权限控制

- 确保只有管理员用户能够执行这些操作 